# Implementation Plan: tr要素（テーブル行）の実装

**Branch**: `149-tr-element-implementation` | **Date**: 2025-11-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/149-tr-element-implementation/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command.

## Summary

HTMLのテーブル行要素（`<tr>`）をFigmaのFrameNodeに変換する機能を実装します。既存のtd/th要素のパターンを踏襲し、横方向のAuto Layoutで子要素を配置する行構造を実現します。コンパニオンオブジェクトパターンとTDDアプローチにより、型安全で保守性の高い実装を提供します。

## Technical Context

**Language/Version**: TypeScript 5.4.3 (strict mode有効)
**Primary Dependencies**:
- Vitest 3.2.4 (テスティングフレームワーク)
- Vite 5.2.6 (ビルドツール)
- @figma/plugin-typings 1.90.0 (Figma API型定義)
**Storage**: N/A (Figmaプラグイン、ローカルストレージのみ)
**Testing**: Vitest（単体テスト、カバレッジ90%以上目標）
**Target Platform**: Figma Desktop App（Figmaプラグインサンドボックス環境）
**Project Type**: Single project (Figmaプラグイン)
**Performance Goals**:
- 要素変換処理: <10ms per element
- テスト実行: <5秒 for all tests
**Constraints**:
- Figmaサンドボックス環境の制約（制限されたAPIアクセス）
- TDD必須（テストファースト開発）
- ESLintルール厳守（eslint-disable禁止）
- npxコマンド使用禁止（npm runスクリプト使用）
**Scale/Scope**:
- 新規要素: 1つ（TrElement）
- テストファイル: 5つ（attributes + 4つのelement tests）
- 推定LOC: ~300行（実装 + テスト）

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ PASS（constitution.mdはテンプレートのため、プロジェクト固有のルールで評価）

### プロジェクト固有のルール準拠

1. **TDD（テスト駆動開発）** ✅
   - テストファーストで実装
   - Red → Green → Refactor サイクルの遵守
   - カバレッジ目標90%以上

2. **既存パターンの踏襲** ✅
   - td/th要素と同じコンパニオンオブジェクトパターン
   - 同じファイル構造とテスト構成
   - 統一されたコーディングスタイル

3. **TypeScript Strict Mode** ✅
   - strict mode有効
   - 明示的な型定義
   - 型安全性の確保

4. **コード品質** ✅
   - ESLintルール準拠（eslint-disable禁止）
   - npxコマンド不使用（npm runスクリプト使用）
   - JSDocドキュメント完備

5. **シンプルさの原則（YAGNI）** ✅
   - 必要最小限の機能実装
   - colspan/rowspan等の高度な機能は将来対応
   - 既存ユーティリティの活用

### Phase 1後の再評価

**Status**: ✅ PASS（2025-11-20 完了）

Phase 1（設計）完了後の再確認:
- ✅ **データモデルの妥当性**
  - TrAttributes: GlobalAttributesを継承し、width/height属性を追加（td要素と一貫性あり）
  - TrElement: BaseElementを継承し、型安全な子要素定義（TdElement[] | ThElement[] | []）
  - Figma変換モデル（FigmaNodeConfig）は既存パターンと整合

- ✅ **API設計の一貫性**
  - Companion Objectパターンの採用（isTrElement, create, toFigmaNode, mapToFigma）
  - 既存のtd/th要素と完全に同じメソッドシグネチャ
  - Pure Functionsと不変性の保証

- ✅ **テスト戦略の網羅性**
  - 5つのテストファイル構成（attributes + 4つのelement tests）
  - Factory、Type Guards、toFigmaNode、mapToFigmaの各側面をカバー
  - カバレッジ目標90%以上達成見込み

**結論**: 設計は妥当であり、実装フェーズに進んで問題なし

## Project Structure

### Documentation (this feature)

```text
specs/149-tr-element-implementation/
├── plan.md              # ✅ This file
├── spec.md              # ✅ Feature specification
├── research.md          # ✅ Phase 0 output
├── data-model.md        # Phase 1 output (next)
├── quickstart.md        # Phase 1 output (next)
├── contracts/           # Phase 1 output (next)
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
src/converter/elements/table/
├── td/                          # 既存：データセル
│   ├── td-attributes/
│   │   ├── td-attributes.ts
│   │   ├── __tests__/
│   │   └── index.ts
│   ├── td-element/
│   │   ├── td-element.ts
│   │   ├── __tests__/
│   │   │   ├── td-element.factory.test.ts
│   │   │   ├── td-element.typeguards.test.ts
│   │   │   ├── td-element.toFigmaNode.test.ts
│   │   │   └── td-element.mapToFigma.test.ts
│   │   └── index.ts
│   └── index.ts
├── th/                          # 既存：ヘッダーセル
│   └── [same structure as td]
├── tr/                          # 新規：テーブル行
│   ├── tr-attributes/
│   │   ├── tr-attributes.ts         # ⬅ 新規作成
│   │   ├── __tests__/
│   │   │   └── tr-attributes.test.ts # ⬅ 新規作成
│   │   └── index.ts                 # ⬅ 新規作成
│   ├── tr-element/
│   │   ├── tr-element.ts            # ⬅ 新規作成
│   │   ├── __tests__/
│   │   │   ├── tr-element.factory.test.ts      # ⬅ 新規作成
│   │   │   ├── tr-element.typeguards.test.ts   # ⬅ 新規作成
│   │   │   ├── tr-element.toFigmaNode.test.ts  # ⬅ 新規作成
│   │   │   └── tr-element.mapToFigma.test.ts   # ⬅ 新規作成
│   │   └── index.ts                 # ⬅ 新規作成
│   └── index.ts                     # ⬅ 新規作成
└── index.ts                         # 変更：TrElement/TrAttributesのエクスポート追加
```

**Structure Decision**:

Single project構造を採用。既存のtd/th要素と同じディレクトリ階層でtr要素を実装します。
- `tr-attributes/`: 属性定義とそのテスト
- `tr-element/`: 要素実装と4つのテストファイル（factory, typeguards, toFigmaNode, mapToFigma）
- 各フォルダに`index.ts`でエクスポートを整理
- `table/index.ts`にTrElement/TrAttributesを追加してエクスポート

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**Status**: N/A - Constitution Checkで違反なし

この実装は既存パターンを踏襲し、不要な複雑性を導入しません。

---

## Phase 0-1 完了報告

### Phase 0: Outline & Research ✅

**完了日**: 2025-11-20

**成果物**:
- ✅ `spec.md` - 機能仕様書
- ✅ `research.md` - 技術調査ドキュメント

**主要な決定事項**:
1. コンパニオンオブジェクトパターンの採用（既存パターン踏襲）
2. 横方向（HORIZONTAL）Auto Layout の使用
3. 子要素型の定義: `TdElement[] | ThElement[] | []`
4. width/height属性の追加（td要素と同様）

**NEEDS CLARIFICATION項目**: すべて解決済み

---

### Phase 1: Design & Contracts ✅

**完了日**: 2025-11-20

**成果物**:
- ✅ `data-model.md` - データモデル定義
- ✅ `contracts/tr-element-api.md` - API契約仕様
- ✅ `quickstart.md` - 実装ガイド
- ✅ エージェントコンテキスト更新（CLAUDE.md）

**データモデル**:
- `TrAttributes`: GlobalAttributesを拡張（width/height追加）
- `TrElement`: BaseElement<"tr", TrAttributes>を継承
- FigmaNodeConfig: FrameNodeベース（HORIZONTAL Auto Layout）

**API契約**:
- `isTrElement(node)`: 型ガード
- `create(attributes)`: ファクトリメソッド
- `toFigmaNode(element)`: Figma変換
- `mapToFigma(node)`: マッピング

**Constitution Check（再評価）**: ✅ PASS
- データモデルの妥当性確認
- API設計の一貫性確認
- テスト戦略の網羅性確認

---

## 次のステップ

**Phase 2**: `/speckit.tasks` コマンドで `tasks.md` を生成し、実装タスクに分解します。

**実装開始前の確認事項**:
- [ ] すべての設計ドキュメントをレビュー
- [ ] 依存関係（td/th要素）が正常に動作していることを確認
- [ ] テスト環境の準備
- [ ] ブランチが正しく作成されていることを確認

**推定実装期間**: 1日

**完了条件**:
- 全テストがパス（カバレッジ90%以上）
- ESLint/型チェックがパス
- `src/converter/elements/table/index.ts` へのエクスポート追加
- PRの作成とレビュー準備完了
