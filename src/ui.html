<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML to Figma Converter</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 20px;
      margin: 0 0 20px 0;
      color: #333;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 8px;
      color: #666;
    }
    
    textarea {
      width: 100%;
      height: 200px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
    }
    
    textarea:focus {
      outline: none;
      border-color: #5551ff;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    button {
      padding: 10px 20px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .primary {
      background-color: #5551ff;
      color: white;
      border: none;
    }
    
    .primary:hover {
      background-color: #4441cc;
    }
    
    .primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .secondary {
      background-color: white;
      color: #666;
      border: 1px solid #ddd;
    }
    
    .secondary:hover {
      background-color: #f5f5f5;
    }
    
    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }
    
    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .optimization-panel {
      margin-top: 16px;
      padding: 12px;
      background-color: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }

    .optimization-panel h3 {
      font-size: 14px;
      margin: 0 0 8px 0;
      color: #495057;
    }

    .optimization-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .optimization-toggle input[type="checkbox"] {
      cursor: pointer;
    }

    .optimization-toggle label {
      display: inline;
      font-size: 14px;
      margin-bottom: 0;
      cursor: pointer;
    }

    .mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .mode-toggle button {
      padding: 4px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      background: white;
      cursor: pointer;
    }

    .mode-toggle button.active {
      background-color: #5551ff;
      color: white;
      border-color: #5551ff;
    }

    .optimization-results {
      margin-top: 12px;
      display: none;
    }

    .optimization-results h4 {
      font-size: 14px;
      margin: 0 0 8px 0;
      color: #495057;
    }

    .proposal-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .proposal-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      font-size: 14px;
    }

    .proposal-item .info {
      flex: 1;
    }

    .proposal-item .actions {
      display: flex;
      gap: 4px;
    }

    .proposal-item .actions button {
      padding: 2px 8px;
      font-size: 11px;
    }

    .optimization-summary {
      margin-top: 8px;
      padding: 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      font-size: 14px;
      color: #495057;
    }

    .summary-stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>HTML to Figma Converter</h1>
    
    <div class="input-group">
      <label for="html-input">HTMLコードを入力してください:</label>
      <textarea 
        id="html-input" 
        placeholder="<div>&#10;  <h1>Hello World</h1>&#10;  <p>This is a paragraph</p>&#10;</div>"
      ></textarea>
    </div>
    
    <div class="optimization-panel">
      <h3>スタイル最適化</h3>
      <div class="optimization-toggle">
        <input type="checkbox" id="optimize-styles" />
        <label for="optimize-styles">冗長なスタイルを最適化</label>
      </div>
      <div id="mode-toggle-area" class="mode-toggle" style="display: none;">
        <button id="mode-auto" class="active" aria-pressed="true" onclick="setOptimizationMode('auto')">自動</button>
        <button id="mode-manual" aria-pressed="false" onclick="setOptimizationMode('manual')">手動</button>
      </div>

      <div id="optimization-results" class="optimization-results">
        <h4>最適化提案</h4>
        <div id="proposal-list" class="proposal-list"></div>
        <div id="apply-approved-area" style="display: none; margin-top: 8px;">
          <button class="primary" onclick="applyApprovedProposals()">承認済みの提案を適用</button>
        </div>
        <div id="optimization-summary" class="optimization-summary" style="display: none;"></div>
      </div>
    </div>

    <div class="button-group">
      <button class="secondary" onclick="cancel()">キャンセル</button>
      <button class="primary" onclick="convertHTML()">変換</button>
    </div>

    <div id="message" class="message"></div>
  </div>

  <script>
    const MESSAGE_DISPLAY_DURATION = 3000;
    let optimizationMode = 'auto';
    let lastProposals = null;
    let messageTimerId = null;

    document.getElementById('optimize-styles').addEventListener('change', function() {
      const modeArea = document.getElementById('mode-toggle-area');
      if (!modeArea) return;
      modeArea.style.display = this.checked ? 'flex' : 'none';
      if (!this.checked) {
        const resultsEl = document.getElementById('optimization-results');
        if (resultsEl) resultsEl.style.display = 'none';
      }
    });

    function setOptimizationMode(mode) {
      optimizationMode = mode;
      const autoBtn = document.getElementById('mode-auto');
      const manualBtn = document.getElementById('mode-manual');
      if (!autoBtn || !manualBtn) return;
      autoBtn.className = mode === 'auto' ? 'active' : '';
      manualBtn.className = mode === 'manual' ? 'active' : '';
      autoBtn.setAttribute('aria-pressed', String(mode === 'auto'));
      manualBtn.setAttribute('aria-pressed', String(mode === 'manual'));

      if (lastProposals) {
        renderProposals(lastProposals);
      }
      var applyArea = document.getElementById('apply-approved-area');
      if (applyArea) {
        applyArea.style.display = mode === 'manual' ? 'block' : 'none';
      }
    }

    function convertHTML() {
      const htmlInput = document.getElementById('html-input');
      if (!htmlInput) return;
      const html = htmlInput.value.trim();

      if (!html) {
        showMessage('HTMLコードを入力してください', 'error');
        return;
      }

      const optimizeStylesEl = document.getElementById('optimize-styles');
      const optimizeStyles = optimizeStylesEl ? optimizeStylesEl.checked : false;

      parent.postMessage({
        pluginMessage: {
          type: 'convert-html',
          html: html,
          optimizeStyles: optimizeStyles,
          optimizationMode: optimizationMode
        }
      }, '*');
    }

    function cancel() {
      parent.postMessage({
        pluginMessage: {
          type: 'cancel'
        }
      }, '*');
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      if (!messageEl) return;
      messageEl.textContent = text;
      messageEl.className = 'message ' + type;
      messageEl.style.display = 'block';

      if (messageTimerId !== null) {
        clearTimeout(messageTimerId);
      }
      messageTimerId = setTimeout(function() {
        messageEl.style.display = 'none';
        messageTimerId = null;
      }, MESSAGE_DISPLAY_DURATION);
    }

    function renderProposals(proposals) {
      lastProposals = proposals;
      const list = document.getElementById('proposal-list');
      if (!list) return;
      const fragment = document.createDocumentFragment();

      proposals.forEach(function(proposal) {
        // MCP等の外部ソースから不正なproposalが渡される可能性があるため
        if (!proposal || typeof proposal.id !== 'string' || proposal.id === '' ||
            !proposal.issue || typeof proposal.issue.description !== 'string') {
          return;
        }

        const item = document.createElement('div');
        item.className = 'proposal-item';
        item.setAttribute('data-id', proposal.id);

        const info = document.createElement('div');
        info.className = 'info';
        info.textContent = proposal.issue.description;

        item.appendChild(info);

        if (optimizationMode === 'manual') {
          const actions = document.createElement('div');
          actions.className = 'actions';

          const approveBtn = document.createElement('button');
          approveBtn.className = 'primary';
          approveBtn.textContent = '承認';
          approveBtn.onclick = function() { approveProposal(proposal.id); };

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'secondary';
          rejectBtn.textContent = '却下';
          rejectBtn.onclick = function() { rejectProposal(proposal.id); };

          actions.appendChild(approveBtn);
          actions.appendChild(rejectBtn);
          item.appendChild(actions);
        }

        fragment.appendChild(item);
      });

      while (list.firstChild) { list.removeChild(list.firstChild); }
      list.appendChild(fragment);
    }

    function createSummaryStat(label, value) {
      const row = document.createElement('div');
      row.className = 'summary-stat';
      const labelSpan = document.createElement('span');
      labelSpan.textContent = label;
      const valueSpan = document.createElement('span');
      valueSpan.textContent = String(value);
      row.appendChild(labelSpan);
      row.appendChild(valueSpan);
      return row;
    }

    function renderSummary(summary, comparison) {
      const el = document.getElementById('optimization-summary');
      if (!el) return;
      el.style.display = 'block';
      el.textContent = '';
      el.appendChild(createSummaryStat('検出された問題:', summary.totalIssues));
      el.appendChild(createSummaryStat('適用済み:', summary.applied));
      el.appendChild(createSummaryStat('削減率:', comparison.reductionPercentage + '%'));
    }

    function findProposalItemById(id) {
      const items = document.querySelectorAll('.proposal-item');
      for (let i = 0; i < items.length; i++) {
        if (items[i].getAttribute('data-id') === id) {
          return items[i];
        }
      }
      return null;
    }

    function approveProposal(id) {
      const item = findProposalItemById(id);
      if (item) {
        item.style.backgroundColor = '#d4edda';
        item.setAttribute('data-approved', 'true');
      }
    }

    function rejectProposal(id) {
      const item = findProposalItemById(id);
      if (item) {
        item.style.backgroundColor = '#f8d7da';
        item.removeAttribute('data-approved');
      }
    }

    function applyApprovedProposals() {
      const approvedIds = [];
      const items = document.querySelectorAll('.proposal-item[data-approved="true"]');
      items.forEach(function(item) {
        const id = item.getAttribute('data-id');
        if (id) approvedIds.push(id);
      });

      if (approvedIds.length === 0) {
        showMessage('承認された提案がありません', 'error');
        return;
      }

      const htmlInput = document.getElementById('html-input');
      const html = htmlInput ? htmlInput.value.trim() : '';

      parent.postMessage({
        pluginMessage: {
          type: 'apply-optimization',
          html: html,
          approvedProposalIds: approvedIds
        }
      }, '*');
    }

    window.onmessage = function(event) {
      if (!event.data || !event.data.pluginMessage) return;
      const msg = event.data.pluginMessage;

      if (msg.type === 'conversion-complete') {
        showMessage(msg.message, 'success');
        const htmlInputEl = document.getElementById('html-input');
        if (htmlInputEl) htmlInputEl.value = '';
      } else if (msg.type === 'conversion-error') {
        showMessage(msg.message, 'error');
      } else if (msg.type === 'optimization-result') {
        const resultsEl = document.getElementById('optimization-results');
        if (resultsEl) resultsEl.style.display = 'block';
        renderProposals(msg.result.proposals);
        renderSummary(msg.result.summary, msg.result.comparison);
        const applyArea = document.getElementById('apply-approved-area');
        if (applyArea) applyArea.style.display = optimizationMode === 'manual' ? 'block' : 'none';
      } else if (msg.type === 'optimization-applied') {
        showMessage(msg.message, 'success');
        const resultsEl = document.getElementById('optimization-results');
        if (resultsEl) resultsEl.style.display = 'none';
      } else if (msg.type === 'optimization-error') {
        showMessage(msg.message, 'error');
      }
    };
  </script>
</body>
</html>